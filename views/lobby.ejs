<%- include('./shared/head', { title: 'Poker Lobby' }) %>
<body data-user-id="<%= user ? user.id : '' %>" data-username="<%= user ? user.username : '' %>">
  <header>
    <h1>Poker Game</h1>
    <div class="nav-links">
      <span class="nav-user">Welcome, <%= user ? user.username : 'Guest' %></span>
      <a href="/play">Play Game</a>
      <a href="/sign-out">Sign Out</a>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="row">
        <!-- Left Column: Game List -->
        <div class="col-8">
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Available Games</h5>
              <button class="btn btn-primary btn-sm" id="create-game-modal-btn">Create Game</button>
            </div>
            <div class="card-body">
              <div class="games-list" id="games-list">
                <% if (games && games.length > 0) { %>
                  <% games.forEach(game => { %>
                    <div class="game-card mb-3 p-3 border rounded">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h5 class="mb-1"><%= game.name %></h5>
                          <span class="badge <%= game.state === 'WAITING' ? 'bg-success' : 'bg-warning' %>">
                            <%= game.state %>
                          </span>
                        </div>
                        <div>
                          <button class="btn btn-sm btn-outline-secondary detail-btn me-2" data-id="<%= game.id %>">
                            Details
                          </button>
                          <button class="btn btn-sm btn-primary join-btn" data-id="<%= game.id %>" 
                                  <%= (game.current_players >= game.max_players) ? 'disabled' : '' %>>
                            <%= (game.current_players >= game.max_players) ? 'Full' : 'Join Game' %>
                          </button>
                        </div>
                      </div>
                      <div class="mt-2">
                        <small class="text-muted">
                          Players: <%= game.current_players %>/<%= game.max_players %> | 
                          Created by: <%= game.creator_name || 'Unknown' %>
                        </small>
                      </div>
                    </div>
                  <% }); %>
                <% } else { %>
                  <div class="text-center py-4">
                    <p>No games available. Create one!</p>
                  </div>
                <% } %>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <button id="add-funds-btn" class="btn btn-outline-success w-100 mb-2">
                    <i class="fas fa-wallet"></i> Add Funds
                  </button>
                </div>
                <div class="col-6">
                  <button id="cash-out-btn" class="btn btn-outline-primary w-100 mb-2">
                    <i class="fas fa-money-bill-wave"></i> Cash Out
                  </button>
                </div>
                <div class="col-6">
                  <button id="join-game-modal-btn" class="btn btn-primary w-100">
                    <i class="fas fa-sign-in-alt"></i> Join Game
                  </button>
                </div>
                <div class="col-6">
                  <button id="create-game-btn" class="btn btn-success w-100">
                    <i class="fas fa-plus-circle"></i> Create Game
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Friends and Chat -->
        <div class="col-4">
          <!-- Friends section - only needs this part updated -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Friends</h5>
  </div>
  <div class="card-body friends-list" style="max-height: 300px; overflow-y: auto;">
    <% if (typeof friends !== 'undefined' && friends && friends.length > 0) { %>
      <% friends.forEach(friend => { %>
        <div class="friend-item d-flex align-items-center mb-2 p-2 border-bottom">
          <div class="friend-avatar <%= friend.online ? 'bg-success' : 'bg-secondary' %> text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 40px; height: 40px;">
            <%= friend.username.charAt(0).toUpperCase() %>
          </div>
          <div class="friend-info flex-grow-1">
            <div class="friend-name"><%= friend.username %></div>
            <small class="friend-status text-muted">
              <% if (friend.online) { %>
                <% if (friend.currentGame) { %>
                  Playing <%= friend.currentGame %>
                <% } else { %>
                  Online
                <% } %>
              <% } else { %>
                Offline
              <% } %>
            </small>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <div class="text-center py-3">
        <p>You haven't added any friends yet.</p>
      </div>
    <% } %>
  </div>
</div>

          <div class="card">
            <div class="card-header">
              <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                  <a class="nav-link active" href="#" data-chat="global">Global Chat</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-chat="friends">Friends</a>
                </li>
              </ul>
            </div>
            <div class="card-body p-0">
              <div class="chat-messages p-3" id="chat-messages" style="height: 300px; overflow-y: auto;">
                <div class="text-center py-3">
                  <p>No messages yet. Start the conversation!</p>
                </div>
              </div>
              <div class="p-2 border-top">
                <form id="chat-form" class="d-flex">
                  <input type="text" id="chat-input" class="form-control me-2" placeholder="Type your message...">
                  <button type="submit" class="btn btn-primary">Send</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <!-- Add Funds Modal -->
  <div class="modal fade" id="add-funds-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Funds</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="add-funds-form">
            <div class="mb-3">
              <label for="amount" class="form-label">Amount:</label>
              <input type="number" class="form-control" id="amount" name="amount" min="10" step="5" required>
            </div>
            <!-- Replace the payment method select in lobby.ejs -->
<div class="mb-3">
  <label for="payment-method" class="form-label">Payment Method:</label>
  <select class="form-select" id="payment-method" name="payment-method" required>
    <option value="">Select payment method</option>
    <option value="credit-card">Credit Card</option>
    <option value="paypal">PayPal</option>
    <option value="crypto">Cryptocurrency</option>
  </select>
</div>
            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Add Funds</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Join Game Modal -->
  <div class="modal fade" id="join-game-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Join Game</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="join-game-form">
            <div class="mb-3">
              <label for="game-id" class="form-label">Game ID:</label>
              <input type="text" class="form-control" id="game-id" name="game-id" required>
            </div>
            <div class="mb-3">
              <label for="buy-in-amount" class="form-label">Buy-in Amount:</label>
              <input type="number" class="form-control" id="buy-in-amount" name="buy-in-amount" min="10" step="5" required>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Join Game</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Game Modal -->
  <div class="modal fade" id="create-game-modal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Game</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="create-game-form">
            <div class="mb-3">
              <label for="game-name" class="form-label">Game Name:</label>
              <input type="text" class="form-control" id="game-name" name="game-name" required>
            </div>
            <div class="mb-3">
              <label for="min-buy-in" class="form-label">Minimum Buy-in:</label>
              <input type="number" class="form-control" id="min-buy-in" name="min-buy-in" min="10" step="5">
            </div>
            <div class="mb-3">
              <label for="max-players" class="form-label">Maximum Players:</label>
              <input type="number" class="form-control" id="max-players" name="max-players" min="2" max="10" value="6" required>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="private-game" name="private-game">
              <label class="form-check-label" for="private-game">Private Game</label>
            </div>
            <div class="text-end">
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Create Game</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts loaded in correct order -->
  <!-- 1. Bootstrap JS - MUST be first -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- 2. Socket.io Client -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- 3. Font Awesome for Icons -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

  <!-- 4. Our Compiled JS - Last to ensure all dependencies are loaded -->
  <script src="/js/main.js"></script>
  
</body>
</html>